name: Smoke Test Live Demo

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  smoke-test:
    runs-on: ubuntu-latest
    env:
      TARGET_URL: https://pdf-parser-pro-bibhu342.streamlit.app/
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Wait for deployment (retry loop)
        run: |
          echo "Waiting up to 3 minutes for the site to respond..."
          attempt=0
          max=18   # 18 * 10s = 180s
          while [ $attempt -lt $max ]; do
            code=$(curl -s -o /dev/null -w "%{http_code}" "$TARGET_URL" || echo "000")
            echo "Attempt $((attempt+1)): HTTP $code"
            if [ "$code" = "200" ]; then
              echo "Site is up (HTTP 200)."
              exit 0
            fi
            attempt=$((attempt+1))
            sleep 10
          done
          echo "Site did not return HTTP 200 within timeout."
          exit 1

      - name: Quick content check
        if: success()
        run: |
          # fetch a small portion and verify expected text presence (case-insensitive)
          content=$(curl -s "$TARGET_URL" | tr '[:upper:]' '[:lower:]')
          if echo "$content" | grep -q "pdf-parser-pro"; then
            echo "Basic content check OK."
          else
            echo "Basic content check failed â€” expected text not found."
            exit 1
          fi
